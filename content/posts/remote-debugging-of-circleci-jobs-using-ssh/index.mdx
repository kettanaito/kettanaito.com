---
date: 2020-01-01
category: Education
title: 'Remote debugging of CircleCI jobs using SSH'
description: Got a failing CI job? Debug it precisely on the remote machine using SSH in minutes.
keywords:
  - circleci
  - continuous integration
  - ssh
  - debugging
  - job
  - workflow
image: thumbnail.jpg
---

## Introduction

I have been using [CircleCI](https://circleci.com/) in my projects for more than two years now and I love it! Well, at least until it comes to changing `.circleci/config.yml`. If you have any experience with CircleCI you know what a complicated beast its configuration may become. However, I am not here to complain, but to share how my lack of experience prevented me from debugging failing jobs.

I am ashamed to admit that any significant change in CircleCI config used to take me about 30 failing workflows to get right. By the time I get there I begin to hate the red color so much.

![CircleCI failed job](images/circleci-failed-job.png)

Today I would like to share with you a great technique to debug CircleCI jobs using SSH connection to the remote machine. Basically, this would allow you to open the \_exact state of the remote machine that runs your job, navigate it, read files and execute commands.

### Debugging cycle

Debugging an issue is impossible without reliably reproducing it. There are multifold of things that can affect the issue's reproduction: environment, connection speed, asynchronicity, black magic. Needless to say when your CI runs remotely all those factors are at play.

---

## Running a job with SSH

In order to debug a failed job using SSH it needs to be run with SSH first. Luckily, this is possible from the CircleCI UI straight away:

1. Open the failed job on CircleCI.
1. Locate the "Rerun ???" / "Rerun workflow" button.
1. Open the dropdown and choose "Rerun job with SSH" option.

![Rerun job with SSH](images/circleci-rerun-ssh.png)

Clicking on "Rerun job with SSH" will run the job anew. This time, however, CircleCI will issue a SSH connection to the remote machine. Take a look at the respective step of the rerun job for more details:

![](images/enable-ssh.png)

It is important to notice a machine's host (`54.208.32.182`) and port (`64536`). We are going to use those to connect to the remote machine.

> The hostname and port number may be different in your case. Take the exact data printed by the CircleCI job.

## Connecting to the remote machine

Using a UNIX-based computer, you can connect to a remote SSH server using the `ssh` command from your terminal:

```bash
$ ssh -p 64536 54.208.32.182
```

When successfully executed, you will notice your terminal's host changing from the local computer name to the remote machine's name.

> Screenshot of the terminal window showing the `ssh` command executed and new machine context present.

Any terminal commands you use in this process are executed _on the remote machine_. Browse directories and files, run your project's scripts.

### Using SSH key

By default, attempts to connect to the remote machine using `ssh` would use the SSH key file added in your SSH agent. There can be two issues with this: you either don't have any SSH key, or have multiple ones.

#### Set up an SSH key in GitHub

To create an SSH key and attach it to your GitHub profile please follow the official guide: [Generating a new SSH key and adding it to the ssh-agent](https://help.github.com/en/github/authenticating-to-github/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent).

#### Specify which key to use

In case you have got multiple SSH keys you would have to specify which one to use to connect to the remote machine. Provide the path to the same SSH key you use for GitHub as the value of the `-i` flag in `ssh` command:

```bash
ssh -i ~/.ssh/git_hub.rsa -p 12345 12.123.12.123
```

> Explicit `-i` flag is only necessary if your GitHub SSH is not the default one in your SSH agent.

## Downloading files

Working with the remote file-system via SSH is helpful, yet you might quickly find yourself limited. It is another environment, which lacks your favorite IDE and all those helpful tools you used to use for debugging. It may be helpful to know how to download a file, or an entire working directory, from remote to your local.

Although you should strive towards your project being reproducible, I highly recommend to download a complete snapshot of the file-system, _including installed dependencies_. This way you eliminate any possible deviations and operate on the 1-1 instance of your project from the failed job.

Depending on the project's (and its dependencies) size, transferring its entire directory may take a significant amount of time. We can compress the working directory into a tarball to decrease its size and make the download procedure faster.

```bash
$ tar -czvf ci.tar.gz /.../.../.../source/directory/path/.../
```

- `-c` create an archive,
- `-z` compress the archive using gzip,
- `-v` display progress in the terminal (verbose),
- `-f` accept a file name of the archive.

With the working directory is compressed into `ci.tar.gz` we can download it via SCP protocol using the following command:

```bash
$ scp -P <SSH_PORT> ...???...
```

---

## Materials

- [Debugging with SSH](https://circleci.com/docs/2.0/ssh-access-jobs/) (CircleCI docs)
